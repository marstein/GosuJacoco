<?xml version="1.0" encoding="UTF-8"?>

<project name="org.jacoco.ant.buildhook">
	<property name="do.compile" value="true"/>
	<property name="do.custompackage" value="true"/>
	
	<path id="dependencies">
		<path refid="bundle-org.apache.ant"/>
		<path refid="bundle-org.jacoco.core"/>
		<path refid="bundle-org.jacoco.report"/>
		<path refid="bundle-org.objectweb.asm"/>
	</path>
	
	<fileset dir="${source.bundle.java.dir}" id="classpathresources">
		<include name="org/jacoco/ant/antlib.xml"/>
	</fileset>	
	
	<target name="custompackage">
		<property name="result.dist.bundle.jar.file" location="${result.dist.lib.dir}/${manifest.Bundle-SymbolicName}_${qualified.bundle.version}.jar"/>
		<mkdir dir="${result.dist.lib.dir}"/>
		<jar destfile="${result.dist.bundle.jar.file}" manifest="${result.temp.bundle.manifest.file}" level="9">
			<fileset dir="${result.tmp.bundle.classes.dir}"/>
			<file file="${source.bundle.dir}/about.html"/>
		</jar>

		<!-- create the all-in-one Ant JAR -->
		<taskdef resource="org/jacoco/build/tools/ant/antlib.xml">
			<classpath>
				<path refid="bundle-org.jacoco.build"/>
				<path refid="bundle-org.objectweb.asm"/>
		    </classpath>
		</taskdef>
		
		<jar destfile="${result.dist.lib.dir}/jacocoant.jar">
			<manifest>
				<attribute name="Implementation-Title" value="JaCoCo Ant Tasks"/>
				<attribute name="Implementation-Vendor" value="Mountainminds GmbH &amp; Co. KG"/>
				<attribute name="Implementation-Version" value="${qualified.bundle.version}"/>
			</manifest>		
			<file file="${source.bundle.dir}/about.html"/>
			<file file="${result.dist.lib.dir}/jacocoagent.jar"/>
			<fileset dir="${result.tmp.bundle.classes.dir}"/>
			<fileset dir="${toString:bundle-org.jacoco.report}" excludes="**/*.class"/>
			
			<!-- Just add those classes we really need -->
			<deepclassfileset>
				<seed>
					<fileset dir="${result.tmp.bundle.classes.dir}"/>
				</seed>
				<fileset dir="${toString:bundle-org.jacoco.core}"/>
				<fileset dir="${toString:bundle-org.jacoco.report}"/>
				<zipfileset includes="**/*.class">
		        	<fileset file="${toString:bundle-org.objectweb.asm}"/>
		    	</zipfileset>
			</deepclassfileset>
		</jar>
	</target>
	
</project>