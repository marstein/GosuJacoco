<?xml version="1.0" encoding="UTF-8"?>

<project name="org.jacoco.agent.buildhook">

	<path id="dependencies">
		<path refid="bundle-org.jacoco.core"/>
		<path refid="bundle-org.objectweb.asm"/>
	</path>
	
	<property name="do.compile"       value="true"/>
	<property name="do.custompackage" value="true"/>
	
	<target name="custompackage">
		
		<taskdef resource="org/jacoco/build/tools/ant/antlib.xml">
			<classpath>
				<path refid="bundle-org.jacoco.build"/>
				<path refid="bundle-org.objectweb.asm"/>
		    </classpath>
		</taskdef>
		
		<!-- The purpose of the checksum is to create a unique package name --> 
		<checksum totalproperty="checksum">
			<fileset dir="${result.tmp.bundle.classes.dir}"/>
			<fileset dir="${toString:bundle-org.jacoco.core}"/>
		</checksum>
		
		<echo>The following warning is false (Ant 1.7.0 Bug #47470), the archive is created anyway.</echo>
		<jar destfile="${result.dist.lib.dir}/jacocoagent.jar">
			<manifest>
				<attribute name="Premain-Class" value="org.jacoco._${checksum}.agent.JacocoAgent"/>
				<attribute name="Implementation-Title" value="JaCoCo Java Agent"/>
				<attribute name="Implementation-Vendor" value="Mountainminds GmbH &amp; Co. KG"/>
				<attribute name="Implementation-Version" value="${qualified.bundle.version}"/>
			</manifest>
			
			<!-- Move classes in own namespace to avoid clashes with application
			     classes. This also allows JaCoCo selftests. -->
			<renamedclassfileset>
				
				<mapping from="org/jacoco/(.*)" to="org/jacoco/_${checksum}/$1"/>
				<mapping from="org/objectweb/asm/(.*)" to="org/jacoco/_${checksum}/asm/$1"/>
				
				<!-- Ship required classes only in the agent JAR -->
				<deepclassfileset rootclass="org/jacoco/agent/JacocoAgent">
					<fileset dir="${result.tmp.bundle.classes.dir}"/>
					<fileset dir="${toString:bundle-org.jacoco.core}"/>
					<zipfileset includes="**/*.class">
			        	<fileset file="${toString:bundle-org.objectweb.asm}"/>
			    	</zipfileset>
				</deepclassfileset>
			</renamedclassfileset>
			
		</jar>
	</target>
	
</project>